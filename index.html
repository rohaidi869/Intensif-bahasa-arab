<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Latihan Interaktif - Ø§Ù„Ø¶Ù…Ø§Ø¦Ø±</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Noto+Sans&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Tajawal', 'Noto Sans', sans-serif; font-size: 18px; direction: rtl; text-align: right; padding: 20px; background: linear-gradient(135deg, #e0f7fa, #f3e5f5); min-height: 100vh; margin: 0; }
    h2 { color: #1565c0; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
    .nav-tabs .nav-link { border: 1px solid #1565c0 !important; border-radius: 12px !important; margin: 0 5px; color: #1565c0; font-weight: 600; transition: all 0.3s ease; }
    .nav-tabs .nav-link.active { background-color: #1565c0 !important; color: white !important; border-color: #1565c0 !important; }
    .tab-content > .tab-pane { display: none; }
    .tab-content > .active { display: block; }
    .card { border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; padding: 20px; margin-bottom: 20px; transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .correct { border: 2px solid #4caf50; background-color: #e8f5e8; animation: highlight 0.8s ease-in-out; }
    .incorrect { border: 2px solid #f44336; background-color: #ffebee; animation: shake 0.5s ease-in-out; }
    @keyframes highlight { 0% { background: #fffacd; } 100% { background: #e8f5e8; } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .answer-key { font-size: 0.95em; color: #d32f2f; margin-top: 8px; padding: 6px 10px; background: #ffebee; border-radius: 6px; border: 1px dashed #c62828; }
    .draggable { cursor: grab; display: inline-block; margin: 3px; padding: 8px 12px; background: #0d6efd; color: white; border-radius: 8px; font-weight: 500; user-select: none; transition: all 0.2s; }
    .draggable:hover { background: #0b5ed7; transform: scale(1.05); }
    .draggable:active { cursor: grabbing; }
    .dropzone { min-height: 60px; border: 2px dashed #2196f3; margin: 12px 0; padding: 12px; border-radius: 8px; background: #e3f2fd; transition: all 0.3s; }
    .dropzone:hover { border-color: #0d6efd; background: #bbdefb; }
    .badge.bg-primary { font-size: 1em; padding: 6px 10px; }
    .btn-check { margin: 5px 0; }
    .btn-custom { border-radius: 10px; padding: 10px 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
    .score-badge { font-weight: bold; padding: 8px 16px; border-radius: 50px; display: inline-block; margin-top: 10px; }
    .score-good { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
    .score-average { background: #fff8e1; color: #9c6d00; border: 1px solid #ffab00; }
    .score-low { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
    .footer-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .routine-svg { width: 80px; height: 80px; margin: 10px auto; }
    .dialog-bubble { background: #e3f2fd; border-radius: 18px; padding: 12px 18px; margin: 8px 0; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .dialog-bubble::after { content: ''; position: absolute; bottom: -10px; left: 20px; border-width: 10px 10px 0; border-style: solid; border-color: #e3f2fd transparent; }
    .audio-btn { background: none; border: none; color: #1565c0; cursor: pointer; padding: 3px 6px; border-radius: 50%; transition: all 0.2s; }
    .audio-btn:hover { background: #e3f2fd; transform: scale(1.1); }
    .audio-btn:active { transform: scale(0.95); }
    .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 5px; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 576px) { .btn-custom { font-size: 0.95rem; padding: 8px 16px; } }
    /* Gaya baru untuk penambahbaikan Google Classroom */
    .student-info { background: #e3f2fd; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #1565c0; }
    .submission-info { background: #e8f5e9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #4caf50; }
    .progress-section { margin: 20px 0; }
    .completion-badge { font-size: 0.9em; padding: 5px 10px; margin-left: 10px; }
    .time-tracking { font-size: 0.9em; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="text-center mb-4">
    <div style="position: relative; height: 80px; margin-bottom: 20px;">
      <svg viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg" style="position: absolute; width: 100%; height: 100%;">
        <polygon points="50,20 55,35 70,35 58,45 63,60 50,50 37,60 42,45 30,35 45,35" fill="#FFD54F" opacity="0.8">
          <animate attributeName="opacity" values="0.8;0.2;0.8" dur="3s" repeatCount="indefinite" />
        </polygon>
        <polygon points="200,30 205,40 220,40 208,48 213,60 200,52 187,60 192,48 180,40 195,40" fill="#FFD54F" opacity="0.6">
          <animate attributeName="opacity" values="0.6;0.1;0.6" dur="4s" repeatCount="indefinite" />
        </polygon>
        <path d="M100,40 C105,30 115,30 120,40 C125,30 135,30 140,40 C145,30 155,30 160,40 C160,45 150,50 140,50 C130,50 120,45 100,45 Z" fill="url(#cloudGradient)" />
        <defs>
          <linearGradient id="cloudGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#BBDEFB;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#E3F2FD;stop-opacity:1" />
          </linearGradient>
        </defs>
        <g transform="translate(250, 40)">
          <ellipse cx="0" cy="0" rx="15" ry="5" fill="#1565c0" />
          <path d="M -15 0 L -10 -20 L 10 -20 L 15 0 Z" fill="#1565c0" />
          <rect x="-2" y="-25" width="4" height="5" fill="#1565c0" />
        </g>
      </svg>
    </div>
    <h2><i class="bi bi-stars"></i> Latihan Interaktif: Ø§Ù„Ø¶Ù…Ø§Ø¦Ø±</h2>
    <p class="text-muted">Latihan interaktif untuk Google Classroom - Kata Ganti Nama Bahasa Arab</p>
  </div>

  <!-- Bahagian Maklumat Pelajar -->
  <div class="card student-info">
    <h4><i class="bi bi-person-circle"></i> Maklumat Pelajar</h4>
    <div class="row">
      <div class="col-md-6">
        <div class="mb-3">
          <label for="studentName" class="form-label">Nama Penuh:</label>
          <input type="text" class="form-control" id="studentName" placeholder="Masukkan nama penuh anda (RUMI) ">
        </div>
      </div>
      <div class="col-md-6">
        <div class="mb-3">
          <label for="studentId" class="form-label">ID Pelajar:</label>
          <input type="text" class="form-control" id="studentId" placeholder="Contoh: 254200001">
        </div>
      </div>
    </div>
    <div class="mb-3">
      <label for="courseCode" class="form-label">Kod Kursus (jika ada):</label>
      <input type="text" class="form-control" id="courseCode" placeholder="Kod yang diberikan oleh guru">
    </div>
  </div>

  <!-- Penjejakan Kemajuan -->
  <div class="progress-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Kemajuan Latihan</h5>
      <span id="completionPercentage" class="badge bg-primary completion-badge">0% Selesai</span>
    </div>
    <div class="progress mb-3" style="height: 20px;">
      <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <div id="timeTracking" class="time-tracking">
      <i class="bi bi-clock"></i> Masa digunakan: <span id="timeSpent">0 minit</span>
    </div>
  </div>

  <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active btn-custom" id="tab1" data-bs-toggle="tab" data-bs-target="#section1" type="button" role="tab">
        <i class="bi bi-book"></i> Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link btn-custom" id="tab2" data-bs-toggle="tab" data-bs-target="#section2" type="button" role="tab">
        <i class="bi bi-sort-alpha-down"></i> Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link btn-custom" id="tab3" data-bs-toggle="tab" data-bs-target="#section3" type="button" role="tab">
        <i class="bi bi-chat-left-text"></i> Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­ÙˆØ§Ø±
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link btn-custom" id="tab4" data-bs-toggle="tab" data-bs-target="#section4" type="button" role="tab">
        <i class="bi bi-question-circle"></i> Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
      </button>
    </li>
  </ul>
  
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="section1" role="tabpanel">
      <div class="card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4><i class="bi bi-book"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:</h4>
          <button class="btn btn-sm btn-outline-primary" onclick="playAllAudio()">
            <i class="bi bi-play-circle"></i> Main Semua Audio
          </button>
        </div>
        <div id="vocab-questions"></div>
        <button class="btn btn-primary btn-custom mt-3" onclick="checkVocabAnswers()">
          <i class="bi bi-check2-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        </button>
        <div id="vocab-score" class="mt-3"></div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="section2" role="tabpanel">
      <div class="card">
        <h4><i class="bi bi-sort-alpha-down"></i> Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„ØªÙƒÙˆÙ† Ø¬Ù…Ù„Ø© ØµØ­ÙŠØ­Ø©:</h4>
        <div id="reorder-questions"></div>
        <button class="btn btn-primary btn-custom mt-3" onclick="checkReorderAnswers()">
          <i class="bi bi-check2-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        </button>
        <div id="reorder-score" class="mt-3"></div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="section3" role="tabpanel">
      <div class="card">
        <h4><i class="bi bi-chat-left-text"></i> Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­ÙˆØ§Ø± Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:</h4>
        <div id="dialog-questions"></div>
        <button class="btn btn-primary btn-custom mt-3" onclick="checkDialogAnswers()">
          <i class="bi bi-check2-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        </button>
        <div id="dialog-score" class="mt-3"></div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="section4" role="tabpanel">
      <div class="card">
        <h4><i class="bi bi-question-circle"></i> Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</h4>
        <div id="mcq-questions"></div>
        <button class="btn btn-primary btn-custom mt-3" onclick="checkMcqAnswers()">
          <i class="bi bi-check2-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        </button>
        <div id="mcq-score" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Bahagian Penghantaran Google Classroom -->
  <div class="card submission-info mt-4">
    <h4><i class="bi bi-google"></i> Penghantaran ke Google Classroom</h4>
    <p>Setelah selesai semua bahagian latihan, sila muat turun fail jawapan anda dan hantar melalui Google Classroom.</p>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h5>Status Penghantaran</h5>
        <div id="submissionStatus" class="alert alert-warning" role="alert">
          <i class="bi bi-exclamation-triangle"></i> Latihan belum selesai sepenuhnya.
        </div>
      </div>
      <div class="text-end">
        <button class="btn btn-success btn-custom" onclick="generateSubmissionFile()" id="submitButton" disabled>
          <i class="bi bi-cloud-arrow-down"></i> Jana Fail Penghantaran
        </button>
        <p class="small mt-2">Muat turun fail dan hantar ke Google Classroom</p>
      </div>
    </div>
    
    <div class="footer-buttons">
      <button class="btn btn-success btn-custom" onclick="saveProgress()">
        <i class="bi bi-save"></i> Simpan Kemajuan
      </button>
      <button class="btn btn-secondary btn-custom" onclick="loadProgress()">
        <i class="bi bi-folder-symlink"></i> Muat Semula Kemajuan
      </button>
      <button class="btn btn-primary btn-custom" onclick="printResults()">
        <i class="bi bi-printer"></i> Cetak Keputusan
      </button>
      <button class="btn btn-info btn-custom" onclick="downloadTxt()">
        <i class="bi bi-file-earmark-text"></i> Muat Turun TXT
      </button>
      <button class="btn btn-info btn-custom" onclick="downloadCsv()">
        <i class="bi bi-file-earmark-spreadsheet"></i> Muat Turun CSV
      </button>
    </div>
  </div>

  <script>
    // Data dan fungsi asal latihan
    let scores = { vocab: 0, reorder: 0, dialog: 0, mcq: 0 };
    let startTime = new Date();
    let timeSpent = 0;
    let progressInterval;
    
    const vocabData = [
      { arabic: "Ø£Ù†Ø§", options: ["Kamu", "Saya", "Dia"], answer: "Saya",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#64B5F6" /></svg>' },
      { arabic: "Ø£Ù†ØªÙ", options: ["Dia (perempuan)", "Saya", "Kamu (lelaki)"], answer: "Kamu (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#4CAF50" /></svg>' },
      { arabic: "Ø£Ù†ØªÙ", options: ["Kamu (perempuan)", "Dia (lelaki)", "Kami"], answer: "Kamu (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#E91E63" /></svg>' },
      { arabic: "Ù‡Ùˆ", options: ["Kamu", "Dia (perempuan)", "Dia (lelaki)"], answer: "Dia (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#2196F3" /></svg>' },
      { arabic: "Ù‡ÙŠ", options: ["Dia (perempuan)", "Dia (lelaki)", "Kami"], answer: "Dia (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#9C27B0" /></svg>' },
      { arabic: "Ù†Ø­Ù†", options: ["Kami", "Mereka", "Kamu semua"], answer: "Kami",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#4CAF50" /><rect x="55" y="45" width="20" height="35" fill="#2196F3" /></svg>' },
      { arabic: "Ø£Ù†ØªÙ…", options: ["Kamu semua (lelaki)", "Kami", "Mereka (lelaki)"], answer: "Kamu semua (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#4CAF50" /><rect x="55" y="45" width="20" height="35" fill="#4CAF50" /></svg>' },
      { arabic: "Ø£Ù†ØªÙ†", options: ["Kami", "Kamu semua (perempuan)", "Mereka (perempuan)"], answer: "Kamu semua (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#E91E63" /><rect x="55" y="45" width="20" height="35" fill="#E91E63" /></svg>' },
      { arabic: "Ù‡Ù…", options: ["Mereka (lelaki)", "Mereka (perempuan)", "Kamu semua (lelaki)"], answer: "Mereka (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="10" fill="#FFD54F" /><circle cx="50" cy="30" r="10" fill="#FFD54F" /><circle cx="70" cy="30" r="10" fill="#FFD54F" /><rect x="20" y="45" width="20" height="35" fill="#2196F3" /><rect x="40" y="45" width="20" height="35" fill="#2196F3" /><rect x="60" y="45" width="20" height="35" fill="#2196F3" /></svg>' },
      { arabic: "Ù‡Ù†", options: ["Mereka (lelaki)", "Mereka (perempuan)", "Kamu semua (perempuan)"], answer: "Mereka (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="10" fill="#FFD54F" /><circle cx="50" cy="30" r="10" fill="#FFD54F" /><circle cx="70" cy="30" r="10" fill="#FFD54F" /><rect x="20" y="45" width="20" height="35" fill="#9C27B0" /><rect x="40" y="45" width="20" height="35" fill="#9C27B0" /><rect x="60" y="45" width="20" height="35" fill="#9C27B0" /></svg>' }
    ];

    // Fungsi untuk memulakan penjejakan masa
    function startTimeTracking() {
      startTime = new Date();
      progressInterval = setInterval(updateTimeSpent, 60000); // Update setiap minit
    }
    
    // Fungsi untuk mengemas kini masa yang digunakan
    function updateTimeSpent() {
      const now = new Date();
      timeSpent = Math.floor((now - startTime) / 60000); // dalam minit
      document.getElementById('timeSpent').textContent = `${timeSpent} minit`;
    }
    
    // Fungsi untuk mengemas kini bar kemajuan
    function updateProgress() {
      let completed = 0;
      const totalSections = 4;
      
      // Periksa setiap bahagian sama ada telah disemak
      if (scores.vocab > 0) completed++;
      if (scores.reorder > 0) completed++;
      if (scores.dialog > 0) completed++;
      if (scores.mcq > 0) completed++;
      
      const percentage = Math.round((completed / totalSections) * 100);
      document.getElementById('progressBar').style.width = `${percentage}%`;
      document.getElementById('progressBar').textContent = `${percentage}%`;
      document.getElementById('progressBar').setAttribute('aria-valuenow', percentage);
      document.getElementById('completionPercentage').textContent = `${percentage}% Selesai`;
      
      // Aktifkan butang penghantaran jika semua bahagian selesai
      const submitButton = document.getElementById('submitButton');
      const submissionStatus = document.getElementById('submissionStatus');
      
      if (percentage === 100) {
        submitButton.disabled = false;
        submissionStatus.className = 'alert alert-success';
        submissionStatus.innerHTML = '<i class="bi bi-check-circle"></i> Latihan selesai! Sila jana fail penghantaran.';
      } else {
        submitButton.disabled = true;
        submissionStatus.className = 'alert alert-warning';
        submissionStatus.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Latihan belum selesai sepenuhnya.';
      }
      
      return percentage;
    }
    
    // Fungsi untuk menjana fail penghantaran untuk Google Classroom
    function generateSubmissionFile() {
      const studentName = document.getElementById('studentName').value || 'Nama Tidak Diberikan';
      const studentId = document.getElementById('studentId').value || 'ID Tidak Diberikan';
      const courseCode = document.getElementById('courseCode').value || 'Tiada Kod';
      
      const total = scores.vocab + scores.reorder + scores.dialog + scores.mcq;
      const max = vocabData.length + reorderData.length + dialogData.length + mcqData.length;
      const percent = (total / max * 100).toFixed(1);
      
      // Kumpulkan semua jawapan pelajar
      const studentAnswers = {
        studentInfo: {
          name: studentName,
          id: studentId,
          courseCode: courseCode,
          submissionTime: new Date().toLocaleString('ms-MY'),
          timeSpent: `${timeSpent} minit`
        },
        scores: {
          vocab: scores.vocab,
          reorder: scores.reorder,
          dialog: scores.dialog,
          mcq: scores.mcq,
          total: total,
          maxPossible: max,
          percentage: percent
        },
        answers: {
          vocab: collectVocabAnswers(),
          reorder: collectReorderAnswers(),
          dialog: collectDialogAnswers(),
          mcq: collectMcqAnswers()
        }
      };
      
      // Buat fail JSON
      const jsonData = JSON.stringify(studentAnswers, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      // Nama fail yang bermaklumat
      const fileName = `Penghantaran_${studentName.replace(/\s+/g, '_')}_${courseCode || 'Al-dhamair'}_${new Date().toISOString().slice(0,10)}.json`;
      
      // Muat turun fail
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Tunjukkan arahan penghantaran
      alert(`Fail "${fileName}" telah dimuat turun. Sila hantar fail ini ke Google Classroom mengikut arahan guru anda.`);
    }
    
    // Fungsi untuk mengumpul jawapan bahagian kosa kata
    function collectVocabAnswers() {
      const answers = [];
      vocabData.forEach((item, index) => {
        const select = document.getElementById(`vocab-q${index}`);
        answers.push({
          question: item.arabic,
          studentAnswer: select ? select.value : 'Tidak dijawab',
          correctAnswer: item.answer
        });
      });
      return answers;
    }
    
    // Fungsi untuk mengumpul jawapan bahagian susunan
    function collectReorderAnswers() {
      const answers = [];
      reorderData.forEach((item, index) => {
        const dropzone = document.getElementById(`drop-${index}`);
        const words = dropzone ? Array.from(dropzone.querySelectorAll(".badge")).map(el => el.textContent.trim()) : [];
        answers.push({
          question: item.words.join(', '),
          studentAnswer: words.join(' '),
          correctAnswer: item.correct,
          isCorrect: words.join(' ') === item.correct
        });
      });
      return answers;
    }
    
    // Fungsi untuk mengumpul jawapan bahagian dialog
    function collectDialogAnswers() {
      const answers = [];
      dialogData.forEach((item, index) => {
        const selected = document.querySelector(`input[name="dialog-q${index}"]:checked`);
        answers.push({
          question: item.dialogue.join(' '),
          studentAnswer: selected ? selected.value : 'Tidak dijawab',
          correctAnswer: item.answer
        });
      });
      return answers;
    }
    
    // Fungsi untuk mengumpul jawapan bahagian pilihan
    function collectMcqAnswers() {
      const answers = [];
      mcqData.forEach((item, index) => {
        const selected = document.querySelector(`input[name="mcq-q${index}"]:checked`);
        answers.push({
          question: item.question,
          studentAnswer: selected ? selected.value : 'Tidak dijawab',
          correctAnswer: item.answer
        });
      });
      return answers;
    }
    
    // Fungsi untuk menyimpan kemajuan
    function saveProgress() {
      const progressData = {
        studentName: document.getElementById('studentName').value,
        studentId: document.getElementById('studentId').value,
        courseCode: document.getElementById('courseCode').value,
        scores: scores,
        timeSpent: timeSpent,
        answers: {
          vocab: collectVocabAnswers(),
          reorder: collectReorderAnswers(),
          dialog: collectDialogAnswers(),
          mcq: collectMcqAnswers()
        },
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem('aldhamairProgress', JSON.stringify(progressData));
      alert('Kemajuan telah disimpan. Anda boleh meneruskan latihan ini kemudian.');
    }
    
    // Fungsi untuk memuatkan semula kemajuan
    function loadProgress() {
      const savedProgress = localStorage.getItem('aldhamairProgress');
      if (!savedProgress) {
        alert('Tiada data kemajuan yang disimpan ditemui.');
        return;
      }
      
      const progressData = JSON.parse(savedProgress);
      
      // Isi maklumat pelajar
      document.getElementById('studentName').value = progressData.studentName || '';
      document.getElementById('studentId').value = progressData.studentId || '';
      document.getElementById('courseCode').value = progressData.courseCode || '';
      
      // Isi skor
      scores = progressData.scores;
      
      // Isi masa
      timeSpent = progressData.timeSpent || 0;
      document.getElementById('timeSpent').textContent = `${timeSpent} minit`;
      
      // Isi jawapan
      loadVocabAnswers(progressData.answers.vocab);
      loadReorderAnswers(progressData.answers.reorder);
      loadDialogAnswers(progressData.answers.dialog);
      loadMcqAnswers(progressData.answers.mcq);
      
      // Kemas kini UI
      updateProgress();
      alert('Kemajuan sebelumnya telah dimuatkan. Sila semak semua bahagian dan hantar jika sudah selesai.');
    }
    
    // Fungsi bantu untuk memuatkan jawapan kosa kata
    function loadVocabAnswers(answers) {
      answers.forEach((answer, index) => {
        const select = document.getElementById(`vocab-q${index}`);
        if (select && answer.studentAnswer && answer.studentAnswer !== 'Tidak dijawab') {
          select.value = answer.studentAnswer;
        }
      });
    }
    
    // Fungsi bantu untuk memuatkan jawapan susunan
    function loadReorderAnswers(answers) {
      answers.forEach((answer, index) => {
        const dropzone = document.getElementById(`drop-${index}`);
        if (dropzone && answer.studentAnswer && answer.studentAnswer !== 'Tidak dijawab') {
          dropzone.innerHTML = '';
          answer.studentAnswer.split(' ').forEach(word => {
            const span = document.createElement("span");
            span.className = "badge bg-primary me-1 mb-1";
            span.textContent = word;
            span.draggable = true;
            span.dataset.word = word;
            span.ondragstart = drag;
            dropzone.appendChild(span);
          });
        }
      });
    }
    
    // Fungsi bantu untuk memuatkan jawapan dialog
    function loadDialogAnswers(answers) {
      answers.forEach((answer, index) => {
        if (answer.studentAnswer && answer.studentAnswer !== 'Tidak dijawab') {
          const radio = document.querySelector(`input[name="dialog-q${index}"][value="${answer.studentAnswer}"]`);
          if (radio) radio.checked = true;
        }
      });
    }
    
    // Fungsi bantu untuk memuatkan jawapan pilihan
    function loadMcqAnswers(answers) {
      answers.forEach((answer, index) => {
        if (answer.studentAnswer && answer.studentAnswer !== 'Tidak dijawab') {
          const radio = document.querySelector(`input[name="mcq-q${index}"][value="${answer.studentAnswer}"]`);
          if (radio) radio.checked = true;
        }
      });
    }


    // Fungsi-fungsi asal latihan (dikekalkan dari kod asal)
    function createVocabQuiz() {
      const container = document.getElementById("vocab-questions");
      if (!container) return;
      
      container.innerHTML = "";
      vocabData.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("mb-4");
        div.innerHTML = `
          <div class="p-3 border rounded bg-light d-flex">
            <div class="text-center" style="width: 100px; flex-shrink: 0;">
              ${item.svg}
              <div class="mt-2">
                <strong>${item.arabic}</strong>
                <button class="audio-btn" onclick="speakArabic('${item.arabic}', this)">
                  <span class="loading-spinner" id="spinner-${index}"></span>
                  <i class="bi bi-volume-up"></i>
                </button>
              </div>
            </div>
            <div class="flex-grow-1" dir="ltr" style="padding: 10px 20px;">
              <label class="form-label"><strong>${index + 1}. Pilih maksud yang betul:</strong></label>
              <select class="form-select mt-2" id="vocab-q${index}">
                <option value="">-- Pilih jawapan --</option>
                ${item.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
              </select>
              <div class="answer-key" id="vocab-answer-${index}" style="display: none;"></div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function speakArabic(text, button) {
      const index = Array.from(button.closest('.d-flex').querySelectorAll('.audio-btn')).indexOf(button);
      const spinner = document.getElementById(`spinner-${index}`);
      if (spinner) spinner.style.display = 'inline-block';
      
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ar-SA';
        utterance.rate = 0.9;
        utterance.onend = () => { if (spinner) spinner.style.display = 'none'; };
        utterance.onerror = () => { if (spinner) spinner.style.display = 'none'; };
        speechSynthesis.speak(utterance);
      } else {
        alert('Maaf, pelayar anda tidak menyokong ciri Text-to-Speech.');
        if (spinner) spinner.style.display = 'none';
      }
    }

    function playAllAudio() {
      if (!('speechSynthesis' in window)) {
        alert('Maaf, pelayar anda tidak menyokong ciri Text-to-Speech.');
        return;
      }
      vocabData.forEach((item, index) => {
        setTimeout(() => {
          const utterance = new SpeechSynthesisUtterance(item.arabic);
          utterance.lang = 'ar-SA';
          utterance.rate = 0.9;
          speechSynthesis.speak(utterance);
        }, index * 1500);
      });
    }

    function checkVocabAnswers() {
      let correct = 0;
      vocabData.forEach((item, index) => {
        const select = document.getElementById(`vocab-q${index}`);
        const feedback = document.getElementById(`vocab-answer-${index}`);
        if (!select || !feedback) return;
        
        select.classList.remove("correct", "incorrect");
        feedback.style.display = "none";
        feedback.textContent = "";
        
        if (select.value === item.answer) {
          select.classList.add("correct");
          correct++;
        } else {
          select.classList.add("incorrect");
          feedback.textContent = `Jawapan betul: ${item.answer}`;
          feedback.style.display = "block";
        }
      });
      
      scores.vocab = correct;
      const total = vocabData.length;
      const percent = (correct / total) * 100;
      let badgeClass = percent >= 70 ? "score-good" : percent >= 40 ? "score-average" : "score-low";
      
      const scoreElement = document.getElementById("vocab-score");
      if (scoreElement) {
        scoreElement.innerHTML = `
          <strong>Markah anda: ${correct} / ${total}</strong>
          <div class="score-badge ${badgeClass}">Peratusan: ${percent.toFixed(1)}%</div>
        `;
      }
      
      updateProgress();
    }

    const reorderData = [
      { words: ["ÙÙŠ", "Ø·Ø§Ù„Ø¨", "Ø£Ù†Ø§", "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"], correct: "Ø£Ù†Ø§ Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", translation: "Saya pelajar di sekolah",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#64B5F6" /><rect x="20" y="60" width="60" height="30" fill="#8BC34A" /><rect x="40" y="40" width="20" height="10" fill="#FFC107" /></svg>' },
      { words: ["Ù‡ÙŠ", "Ø¬ÙØ¯ÙÙŠØ¯ÙØ©", "Ù…ÙØ¹ÙÙ„ÙÙ‘Ù…ÙØ©"], correct: "Ù‡ÙŠ Ù…ÙØ¹ÙÙ„ÙÙ‘Ù…ÙØ© Ø¬ÙØ¯ÙÙŠØ¯ÙØ©", translation: "Dia guru perempuan baru",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#9C27B0" /><rect x="20" y="60" width="60" height="30" fill="#8BC34A" /><rect x="40" y="40" width="20" height="10" fill="#FFC107" /></svg>' },
      { words: ["Ù†ÙØ­Ù’Ù†Ù", "Ù†ÙØ°Ù’Ù‡ÙØ¨Ù", "Ø¥ÙÙ„ÙÙ‰", "Ø§Ù„Ù…ÙØ³Ù’Ø¬ÙØ¯"], correct: "Ù†ÙØ­Ù’Ù†Ù Ù†ÙØ°Ù’Ù‡ÙØ¨Ù Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù…ÙØ³Ù’Ø¬ÙØ¯", translation: "Kami pergi ke masjid",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#4CAF50" /><rect x="55" y="45" width="20" height="35" fill="#2196F3" /><path d="M10 85 L90 85 L80 65 L20 65 Z" fill="#795548" /><rect x="40" y="50" width="20" height="35" fill="#FFC107" /></svg>' },
      { words: ["Ù‡ÙÙ…Ù’", "ÙŠÙÙ„Ù’Ø¹ÙØ¨ÙÙˆÙ†Ù", "ÙÙŠ", "Ø§Ù„Ø­ÙØ¯ÙÙŠÙ‚ÙØ©"], correct: "Ù‡ÙÙ…Ù’ ÙŠÙÙ„Ù’Ø¹ÙØ¨ÙÙˆÙ†Ù ÙÙŠ Ø§Ù„Ø­ÙØ¯ÙÙŠÙ‚ÙØ©", translation: "Mereka (lelaki) bermain di taman",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="10" fill="#FFD54F" /><circle cx="50" cy="30" r="10" fill="#FFD54F" /><circle cx="70" cy="30" r="10" fill="#FFD54F" /><rect x="20" y="45" width="20" height="35" fill="#2196F3" /><rect x="40" y="45" width="20" height="35" fill="#2196F3" /><rect x="60" y="45" width="20" height="35" fill="#2196F3" /><circle cx="30" cy="75" r="15" fill="#4CAF50" /><circle cx="70" cy="75" r="15" fill="#4CAF50" /></svg>' },
      { words: ["ØªØ§Ø¬ÙØ±ÙØ©", " Ø£Ù†ØªÙ", "Ù†Ø§Ø¬ÙØ­ÙØ©"], correct: "Ø£Ù†ØªÙ ØªØ§Ø¬ÙØ±ÙØ© Ù†Ø§Ø¬ÙØ­ÙØ©", translation: "Kamu peniaga perempuan yang berjaya",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#E91E63" /><rect x="25" y="60" width="50" height="20" fill="#FFC107" /><rect x="40" y="40" width="20" height="10" fill="#FFC107" /></svg>' }
    ];

    function createReorderQuiz() {
      const container = document.getElementById("reorder-questions");
      if (!container) return;
      
      container.innerHTML = "";
      reorderData.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("mb-4");
        const shuffled = [...item.words].sort(() => Math.random() - 0.5);
        const buttons = shuffled.map(word =>
          `<button type="button" class="draggable" draggable="true" ondragstart="drag(event)" data-word="${word}">
            ${word}
          </button>`
        ).join("");
        
        div.innerHTML = `
          <div class="d-flex">
            <div class="text-center" style="width: 100px; flex-shrink: 0;">
              ${item.svg}
            </div>
            <div class="flex-grow-1" style="padding: 0 20px;">
              <p><strong>${index + 1}.</strong> Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªÙƒÙˆÙ† Ø¬Ù…Ù„Ø© ØµØ­ÙŠØ­Ø©:</p>
              <div class="bg-white p-2 mb-2 rounded border" id="words-${index}">
                ${buttons}
              </div>
              <div class="dropzone p-3" id="drop-${index}" ondrop="drop(event)" ondragover="allowDrop(event)">
                <span class="text-muted">Ø§Ø³Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§...</span>
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="resetOrder(${index})">
                  <i class="bi bi-arrow-counterclockwise"></i> Padam
                </button>
              </div>
              <div class="answer-key" id="reorder-answer-${index}" style="display: none;"></div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.dataset.word); }
    function drop(ev) {
      ev.preventDefault();
      const data = ev.dataTransfer.getData("text");
      const dropzone = ev.target.closest('.dropzone') || ev.target;
      const existingText = dropzone.textContent.trim();
      
      if (existingText === "Ø§Ø³Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§...") { 
        dropzone.innerHTML = ""; 
      }
      
      const span = document.createElement("span");
      span.className = "badge bg-primary me-1 mb-1";
      span.textContent = data;
      span.draggable = true;
      span.dataset.word = data;
      span.ondragstart = drag;
      dropzone.appendChild(span);
    }

    function resetOrder(index) {
      const dropzone = document.getElementById(`drop-${index}`);
      const answerElement = document.getElementById(`reorder-answer-${index}`);
      
      if (dropzone) {
        dropzone.innerHTML = '<span class="text-muted">Ø§Ø³Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§...</span>';
      }
      
      if (answerElement) {
        answerElement.style.display = "none";
      }
    }

    function checkReorderAnswers() {
      let correct = 0;
      reorderData.forEach((item, index) => {
        const dropzone = document.getElementById(`drop-${index}`);
        const feedback = document.getElementById(`reorder-answer-${index}`);
        
        if (!dropzone || !feedback) return;
        
        const words = Array.from(dropzone.querySelectorAll(".badge")).map(el => el.textContent.trim());
        const userAnswer = words.join(" ");
        
        feedback.style.display = "none";
        feedback.textContent = "";
        
        if (userAnswer === item.correct) {
          feedback.innerHTML = `<span class="text-success">Jawapan betul âœ“!</span>`;
          feedback.style.display = "block";
          correct++;
        } else {
          feedback.innerHTML = `Jawapan salah âœ—. <strong>Jawapan betul:</strong> ${item.correct} <em>(${item.translation})</em>`;
          feedback.style.display = "block";
        }
      });
      
      scores.reorder = correct;
      const total = reorderData.length;
      const percent = (correct / total) * 100;
      let badgeClass = percent >= 70 ? "score-good" : percent >= 40 ? "score-average" : "score-low";
      
      const scoreElement = document.getElementById("reorder-score");
      if (scoreElement) {
        scoreElement.innerHTML = `
          <strong>Markah anda: ${correct} / ${total}</strong>
          <div class="score-badge ${badgeClass}">Peratusan: ${percent.toFixed(1)}%</div>
        `;
      }
      
      updateProgress();
    }

    const dialogData = [
      { dialogue: ["Ù…Ù† Ø£Ù†ØªØŸ", "______ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯."], options: ["Ù‡Ùˆ", "Ø£Ù†ØªÙ", "Ø£Ù†Ø§"], answer: "Ø£Ù†Ø§", translation: "saya",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#64B5F6" /></svg>' },
      { dialogue: ["Ù…ÙÙ† Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ§Ø©ØŸ", "______ Ø£Ø®ØªÙŠ."], options: ["Ù‡Ùˆ", "Ù‡ÙŠ", "Ø£Ù†ØªÙ"], answer: "Ù‡ÙŠ", translation: "dia (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#9C27B0" /></svg>' },
      { dialogue: ["Ù…ÙÙ† Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯ØŸ", "______ Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ."], options: ["Ø£Ù†ØªÙ…", "Ù‡Ù†", "Ù‡Ù…"], answer: "Ù‡Ù…", translation: "mereka (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="10" fill="#FFD54F" /><circle cx="50" cy="30" r="10" fill="#FFD54F" /><circle cx="70" cy="30" r="10" fill="#FFD54F" /><rect x="20" y="45" width="20" height="35" fill="#2196F3" /><rect x="40" y="45" width="20" height="35" fill="#2196F3" /><rect x="60" y="45" width="20" height="35" fill="#2196F3" /></svg>' },
      { dialogue: ["Ù‡Ù„ ______ Ø·Ø¨ÙŠØ¨Ø©ØŸ", "Ù†Ø¹Ù…ØŒ ______ Ø·Ø¨ÙŠØ¨Ø©."], options: ["Ù‡ÙŠØŒ Ù‡ÙŠ", "Ù‡ÙˆØŒ Ù‡Ùˆ", "Ø£Ù†ØªÙØŒ Ø£Ù†ØªÙ"], answer: "Ù‡ÙŠØŒ Ù‡ÙŠ", translation: "dia (perempuan), dia (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#9C27B0" /><path d="M40 55 L60 55 L60 65 L40 65 Z" fill="#FFFFFF" /><path d="M45 70 L55 70 L55 75 L45 75 Z" fill="#FFFFFF" /></svg>' },
      { dialogue: ["Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ°Ù‡Ø¨ÙˆÙ†ØŸ", "______ Ù†Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙˆÙ‚."], options: ["Ø£Ù†ØªÙ…", "Ù†Ø­Ù†", "Ù‡Ù…"], answer: "Ù†Ø­Ù†", translation: "Kami",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#4CAF50" /><rect x="55" y="45" width="20" height="35" fill="#2196F3" /><rect x="30" y="60" width="50" height="20" fill="#FFC107" /></svg>' }
    ];

    function createDialogQuiz() {
      const container = document.getElementById("dialog-questions");
      if (!container) return;
      
      container.innerHTML = "";
      dialogData.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("mb-4");
        const options = item.options.map(opt =>
          `<div class="form-check">
            <input class="form-check-input" type="radio" name="dialog-q${index}" value="${opt}" id="dialog-${index}-${opt}">
            <label class="form-check-label" for="dialog-${index}-${opt}">${opt}</label>
          </div>`
        ).join("");
        
        const lines = item.dialogue.map(line => `<div class="dialog-bubble">${line}</div>`).join("");
        
        div.innerHTML = `
          <div class="d-flex">
            <div class="text-center" style="width: 100px; flex-shrink: 0;">
              ${item.svg}
            </div>
            <div class="flex-grow-1" style="padding: 0 20px;">
              <strong>${index + 1}.</strong>
              <div>${lines}</div>
              ${options}
              <div class="answer-key" id="dialog-answer-${index}" style="display: none;"></div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function checkDialogAnswers() {
      let correct = 0;
      dialogData.forEach((item, index) => {
        const selected = document.querySelector(`input[name="dialog-q${index}"]:checked`);
        const feedback = document.getElementById(`dialog-answer-${index}`);
        
        if (!feedback) return;
        
        feedback.style.display = "none";
        feedback.textContent = "";
        
        if (selected && selected.value === item.answer) {
          correct++;
        } else {
          feedback.textContent = `Jawapan betul: ${item.answer} (${item.translation})`;
          feedback.style.display = "block";
        }
      });
      
      scores.dialog = correct;
      const total = dialogData.length;
      const percent = (correct / total) * 100;
      let badgeClass = percent >= 70 ? "score-good" : percent >= 40 ? "score-average" : "score-low";
      
      const scoreElement = document.getElementById("dialog-score");
      if (scoreElement) {
        scoreElement.innerHTML = `
          <strong>Markah anda: ${correct} / ${total}</strong>
          <div class="score-badge ${badgeClass}">Peratusan: ${percent.toFixed(1)}%</div>
        `;
      }
      
      updateProgress();
    }

    const mcqData = [
      { question: "Ù…Ø§ Ø§Ù„Ø¶Ù…ÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù†ÙŠ 'Awak'ØŸ", options: ["Ø£Ù†Ø§", "Ø£Ù†ØªÙ", "Ù‡Ùˆ"], answer: "Ø£Ù†ØªÙ", translation: "Awak",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#64B5F6" /></svg>' },
      { question: "Ù…Ø§ Ù…Ø¹Ù†Ù‰ ÙƒÙ„Ù…Ø© 'Ù‡ÙŠ'ØŸ", options: ["Dia (perempuan)", "Dia (lelaki)", "Kamu (perempuan)"], answer: "Dia (perempuan)", translation: "Dia (perempuan)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="15" fill="#FFD54F" /><rect x="35" y="45" width="30" height="40" fill="#9C27B0" /></svg>' },
      { question: "Ù…Ø§ Ø§Ù„Ø¶Ù…ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø°ÙƒØ± Ø§Ù„ØºØ§Ø¦Ø¨ØŸ", options: ["Ø£Ù†ØªÙ†", "Ù‡Ù†", "Ù‡Ù…"], answer: "Ù‡Ù…", translation: "Mereka (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="10" fill="#FFD54F" /><circle cx="50" cy="30" r="10" fill="#FFD54F" /><circle cx="70" cy="30" r="10" fill="#FFD54F" /><rect x="20" y="45" width="20" height="35" fill="#2196F3" /><rect x="40" y="45" width="20" height="35" fill="#2196F3" /><rect x="60" y="45" width="20" height="35" fill="#2196F3" /></svg>' },
      { question: "Ù…Ø§ Ù…Ø¹Ù†Ù‰ 'Ø£Ù†ØªÙ…'ØŸ", options: ["Kamu semua (lelaki)", "Kamu semua (perempuan)", "Kami"], answer: "Kamu semua (lelaki)", translation: "Kamu semua (lelaki)",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#4CAF50" /><rect x="55" y="45" width="20" height="35" fill="#4CAF50" /></svg>' },
      { question: "Ù…Ø§ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† 'Ø£Ù†ØªÙ' Ùˆ 'Ø£Ù†ØªÙ'ØŸ", options: ["Ø£Ù†ØªÙ Ù„Ù„Ù…Ø°ÙƒØ± ÙˆØ£Ù†ØªÙ Ù„Ù„Ù…Ø¤Ù†Ø«", "Ø£Ù†ØªÙ Ù„Ù„Ù…Ø¤Ù†Ø« ÙˆØ£Ù†ØªÙ Ù„Ù„Ù…Ø°ÙƒØ±", "Ù„Ø§ ÙØ±Ù‚ Ø¨ÙŠÙ†Ù‡Ù…Ø§"], answer: "Ø£Ù†ØªÙ Ù„Ù„Ù…Ø°ÙƒØ± ÙˆØ£Ù†ØªÙ Ù„Ù„Ù…Ø¤Ù†Ø«", translation: "Ø£Ù†ØªÙ untuk lelaki dan Ø£Ù†ØªÙ untuk perempuan",
        svg: '<svg class="routine-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="35" cy="30" r="12" fill="#FFD54F" /><circle cx="65" cy="30" r="12" fill="#FFD54F" /><rect x="25" y="45" width="20" height="35" fill="#4CAF50" /><rect x="55" y="45" width="20" height="35" fill="#E91E63" /></svg>' }
    ];

    function createMcqQuiz() {
      const container = document.getElementById("mcq-questions");
      if (!container) return;
      
      container.innerHTML = "";
      mcqData.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("mb-4");
        const options = item.options.map(opt =>
          `<div class="form-check mcq-option">
            <input class="form-check-input" type="radio" name="mcq-q${index}" value="${opt}" id="mcq-${index}-${opt}">
            <label class="form-check-label" for="mcq-${index}-${opt}">${opt}</label>
          </div>`
        ).join("");
        
        div.innerHTML = `
          <div class="d-flex">
            <div class="text-center" style="width: 100px; flex-shrink: 0;">
              ${item.svg}
            </div>
            <div class="flex-grow-1" style="padding: 0 20px;">
              <p><strong>${index + 1}. ${item.question}</strong></p>
              ${options}
              <div class="answer-key" id="mcq-answer-${index}" style="display: none;"></div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }
<!-- Help Section untuk Pelajar -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning">
                <h6><i class="bi bi-lightbulb"></i> Tips Pantas</h6>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Gunakan <strong>Chrome</strong> atau <strong>Edge</strong> untuk prestasi terbaik</li>
                    <li>Klik butang <strong>ğŸ”Š</strong> untuk dengar sebutan Arab</li>
                    <li>Simpan kemajuan jika tidak dapat habiskan dalam satu sesi</li>
                    <li>Pastikan internet stabil semasa membuat latihan</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6><i class="bi bi-question-circle"></i> Bantuan</h6>
            </div>
            <div class="card-body text-center">
                <button class="btn btn-outline-info mb-2" onclick="showSubmissionGuide()">
                    <i class="bi bi-play-circle"></i> Panduan Video
                </button>
                <br>
                <button class="btn btn-outline-secondary btn-sm" onclick="downloadStepByStepGuide()">
                    <i class="bi bi-download"></i> Muat Turun Arahan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Tracking Enhanced -->
<div class="card mt-3">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Status Penyelesaian</h6>
            <span id="completionStatus" class="badge bg-warning">Sedang Berjalan</span>
        </div>
    </div>
    <div class="card-body">
        <div class="progress mb-2" style="height: 20px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%">0%</div>
        </div>
        <div class="row text-center small">
            <div class="col-3">
                <span id="vocab-status" class="badge bg-secondary">âŒ Kosa Kata</span>
            </div>
            <div class="col-3">
                <span id="reorder-status" class="badge bg-secondary">âŒ Susun Ayat</span>
            </div>
            <div class="col-3">
                <span id="dialog-status" class="badge bg-secondary">âŒ Dialog</span>
            </div>
            <div class="col-3">
                <span id="mcq-status" class="badge bg-secondary">âŒ Pilihan</span>
            </div>
        </div>
    </div>
</div>
    
    function checkMcqAnswers() {
      let correct = 0;
      mcqData.forEach((item, index) => {
        const selected = document.querySelector(`input[name="mcq-q${index}"]:checked`);
        const feedback = document.getElementById(`mcq-answer-${index}`);
        
        if (!feedback) return;
        
        feedback.style.display = "none";
        feedback.textContent = "";
        
        if (selected && selected.value === item.answer) {
          correct++;
        } else {
          feedback.textContent = `Jawapan betul: ${item.answer} (${item.translation})`;
          feedback.style.display = "block";
        }
      });
      
      scores.mcq = correct;
      const total = mcqData.length;
      const percent = (correct / total) * 100;
      let badgeClass = percent >= 70 ? "score-good" : percent >= 40 ? "score-average" : "score-low";
      
      const scoreElement = document.getElementById("mcq-score");
      if (scoreElement) {
        scoreElement.innerHTML = `
          <strong>Markah anda: ${correct} / ${total}</strong>
          <div class="score-badge ${badgeClass}">Peratusan: ${percent.toFixed(1)}%</div>
        `;
      }
      
      updateProgress();
    }

    function printResults() {
      const total = scores.vocab + scores.reorder + scores.dialog + scores.mcq;
      const max = vocabData.length + reorderData.length + dialogData.length + mcqData.length;
      const percent = (total / max * 100).toFixed(1);
      
      let message = `=== KEPUTUSAN LATIHAN: Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± ===
`;
      message += `1. Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª:   ${scores.vocab}/${vocabData.length}
`;
      message += `2. Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ${scores.reorder}/${reorderData.length}
`;
      message += `3. Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­ÙˆØ§Ø±: ${scores.dialog}/${dialogData.length}
`;
      message += `4. Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±:     ${scores.mcq}/${mcqData.length}
`;
      message += `-------------------------------
`;
      message += `JUMLAH: ${total}/${max}
`;
      message += `PERATUSAN: ${percent}%
`;
      message += `===============================
`;
      
      const w = window.open();
      w.document.write(`
        <html dir="ltr">
          <head><title>Keputusan</title></head>
          <body style="font-family: Arial; padding: 40px; line-height: 1.6;">
            <pre style="font-size: 16px;">${message}</pre>
            <p><small>Dicetak pada: ${new Date().toLocaleString('ms-MY')}</small></p>
          </body>
        </html>
      `);
      w.document.close();
      w.print();
    }

    function downloadTxt() {
      const total = scores.vocab + scores.reorder + scores.dialog + scores.mcq;
      const max = vocabData.length + reorderData.length + dialogData.length + mcqData.length;
      const percent = (total / max * 100).toFixed(1);
      
      const text = `KEPUTUSAN LATIHAN: Ø§Ù„Ø¶Ù…Ø§Ø¦Ø±
================================
1. Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª:   ${scores.vocab}/${vocabData.length}
2. Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ${scores.reorder}/${reorderData.length}
3. Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­ÙˆØ§Ø±: ${scores.dialog}/${dialogData.length}
4. Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±:     ${scores.mcq}/${mcqData.length}
-------------------------------
JUMLAH: ${total}/${max}
PERATUSAN: ${percent}%
Dicetak pada: ${new Date().toLocaleString('ms-MY')}
`;
      
      const blob = new Blob([text], { type: "text/plain; charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `keputusan_al_dhamair_${new Date().toISOString().slice(0,10)}.txt`;
      link.click();
    }

    function downloadCsv() {
      const total = scores.vocab + scores.reorder + scores.dialog + scores.mcq;
      const max = vocabData.length + reorderData.length + dialogData.length + mcqData.length;
      
      const csv = [
        ["Seksyen", "Markah", "Tertinggi", "Peratusan"],
        ["Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª", scores.vocab, vocabData.length, ((scores.vocab/vocabData.length)*100).toFixed(1)+"%"],
        ["Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª", scores.reorder, reorderData.length, ((scores.reorder/reorderData.length)*100).toFixed(1)+"%"],
        ["Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­ÙˆØ§Ø±", scores.dialog, dialogData.length, ((scores.dialog/dialogData.length)*100).toFixed(1)+"%"],
        ["Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", scores.mcq, mcqData.length, ((scores.mcq/mcqData.length)*100).toFixed(1)+"%"],
        ["JUMLAH", total, max, ((total/max)*100).toFixed(1)+"%"]
      ].map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
      
      const blob = new Blob([csv], { type: "text/csv; charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `keputusan_al_dhamair_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }

    // Fungsi untuk memulakan aplikasi
    function initializeApp() {
      createVocabQuiz();
      createReorderQuiz();
      createDialogQuiz();
      createMcqQuiz();
      startTimeTracking();
      updateProgress();
      
      // Muatkan kemajuan yang disimpan jika ada
      const savedProgress = localStorage.getItem('aldhamairProgress');
      if (savedProgress) {
        if (confirm('Adakah anda ingin memuatkan kemajuan sebelumnya?')) {
          loadProgress();
        }
      }
    }

    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
